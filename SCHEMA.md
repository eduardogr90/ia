# FlowModel schema & user guide

## JSON schema (conceptual)

```json
{
  "FlowModel": {
    "type": "object",
    "required": ["id", "name", "nodes", "edges"],
    "properties": {
      "id": { "type": "string", "pattern": "^[a-zA-Z0-9-_]+$" },
      "name": { "type": "string", "minLength": 1 },
      "metadata": { "type": "object", "additionalProperties": true },
      "nodes": {
        "type": "array",
        "items": { "$ref": "#/FlowNode" },
        "minItems": 1
      },
      "edges": {
        "type": "array",
        "items": { "$ref": "#/FlowEdge" }
      }
    }
  },
  "FlowNode": {
    "type": "object",
    "required": ["id", "type", "data"],
    "properties": {
      "id": { "type": "string" },
      "type": { "enum": ["question", "action", "message"] },
      "label": { "type": "string" },
      "position": {
        "type": "object",
        "properties": {
          "x": { "type": "number" },
          "y": { "type": "number" }
        }
      },
      "data": { "$ref": "#/NodeData" }
    }
  },
  "NodeData": {
    "type": "object",
    "properties": {
      "question": { "type": "string" },
      "check": { "type": "string" },
      "expectedAnswers": { "type": "array", "items": { "type": "string" } },
      "action": { "type": "string" },
      "parameters": { "type": "object", "additionalProperties": true },
      "message": { "type": "string" },
      "severity": { "type": "string" },
      "metadata": { "type": "object", "additionalProperties": { "type": "string" } }
    }
  },
  "FlowEdge": {
    "type": "object",
    "required": ["source", "target"],
    "properties": {
      "id": { "type": "string" },
      "source": { "type": "string" },
      "target": { "type": "string" },
      "viaLabel": { "type": "string" },
      "data": { "$ref": "#/EdgeData" }
    }
  },
  "EdgeData": {
    "type": "object",
    "properties": {
      "label": { "type": "string" },
      "style": { "enum": ["default", "success", "warning", "danger"] },
      "metadata": { "type": "object", "additionalProperties": { "type": "string" } }
    }
  }
}
```

## YAML example and equivalent graph

YAML generated by `backend/core/yaml_export.py` and mirrored by the frontend preview:

```yaml
id: escalation
name: Escalation
flow:
  start:
    type: question
    question: How can we help?
    expected_answers:
      - yes
      - no
    next:
      yes: qualify
      no: goodbye
  qualify:
    type: action
    action: gather_information
    parameters:
      channel: chat
      priority: high
    next: resolution
  resolution:
    type: message
    message: Issue resolved
  goodbye:
    type: message
    message: Thanks for reaching out
    severity: info
```

Graph interpretation:

- `start` is the root question. Answers outside the `expected_answers` list are rejected during validation.
- `qualify` is an action that forwards automatically to `resolution` (single unlabeled edge → string in YAML).
- `resolution` and `goodbye` terminate the flow because they are message nodes with no outgoing edges.

## Validation summary

The backend validator enforces:

1. Unique node IDs and valid edge references.
2. At least one start node (no incoming edges).
3. At least one terminal message node (message without outgoing edges).
4. Cycle detection with explicit traces (`A -> B -> C -> A`).
5. Label constraints for question nodes (`edge.viaLabel` must exist in `expectedAnswers`).
6. Enumeration of all root → terminal paths, capped at 1000 steps to prevent infinite recursion.

`paths` emitted by `/validate` use this shape:

```json
[
  [
    { "nodeId": "greeting" },
    { "nodeId": "identify", "via": "yes" },
    { "nodeId": "pass" }
  ]
]
```

## User guide with captures

1. **Create a project** — from the Projects page click “New project” or press **Ctrl/Cmd + N**. Provide a name; the slug is generated automatically. _See_ `docs/images/projects-page.svg`.
2. **Add a flow** — open the project, hit “New flow”, and populate initial nodes. Flow IDs follow the slug of the name.
3. **Design the graph** — drag nodes from the palette, connect them on the canvas, and edit details in the inspector. Pan, zoom, and snap-to-grid keep layouts tidy. _See_ `docs/images/editor-overview.svg`.
4. **Validate and review paths** — press **Ctrl/Cmd + E** to open the validation modal. Errors block saves; warnings highlight potential issues. _See_ `docs/images/validation-modal.svg`.
5. **Export artifacts** — use the toolbar to download YAML (`Ctrl/Cmd + J`) or JPG (`Ctrl/Cmd + P`). Toggle **Fit to content** to auto-frame the canvas before html2canvas captures the image. Use the YAML preview panel for instant verification before hitting the backend exporter.

Keep large graphs organised by grouping related nodes horizontally and running auto-layout after major edits.
